{% extends 'base.html' %}
{% block content %}

{% if hero %}
<div class="hero-section m-0" style="position: relative;">
  <img src="{{ hero.image.url }}" class="img-fluid w-100" alt="Sell Hero Image">

  <div class="position-absolute top-50 start-0 translate-middle-y ps-5">
    <div class="shadow-lg rounded px-4 py-3 mt-4 ms-3" style="max-width: 500px;">
      <h2 class="text-dark fw-bold text-center" style="text-shadow: 2px 2px 4px #0a91c3;">
        {{ hero.heading|linebreaks }}
      </h2>
    </div>
  </div>
</div>
{% endif %}


<div id="sell-section" class="sell-form-section m-4">
  <div class="overlay"></div>

  <div class="sell-form-container text-center">
    <h2 class="sell-title text-black fw-bold pb-4 pt-3">Sell Fast By <span class="brand-accent" style="color: #07435C;">Drive<span class="highlight" style="color: rgb(6, 6, 134);">RP</span></span></h2>
    <p class="subtitle fw-bold m-5 fs-4">Enter Your Details</p>

    <form id="sell-bike-form" method="POST">
      {% csrf_token %}
      <div class="dropdown-group mb-4">
        <select id="brand" disabled><option selected>Select Brand</option></select>
        <select id="model" disabled><option selected>Select Model</option></select>
        <select id="variant" disabled><option selected>Select Variant</option></select>
        <select id="year" disabled><option selected>Select Year</option></select>
        <select id="kms" disabled>
          <option selected>Select KMs Driven</option>
          <option>0-5,000</option>
          <option>5,001-10,000</option>
          <option>10,001-20,000</option>
          <option>20,001+</option>
        </select>
        <select id="owner" disabled>
          <option selected>Select Owner</option>
          <option>1st</option>
          <option>2nd</option>
          <option>3rd</option>
        </select>
        <button type="submit" disabled id="get-price-btn">Get Price</button>
      </div>
    </form>

    <div class="price-result" id="price-result" style="display:none;"></div>
    <div class="justify-content-center align-items-center d-flex">
    <div class="fw-bold text-center text-black  mt-5" style="width: 60%;">
      Can’t find what You’re Looking For ? <a class="text-decoration-none" style="color: #07435C;" href="{% url 'contact:contact_us' %}">Click Here</a>
    </div>
    </div>
  </div>
</div>

<!-- How it works -->

<section class="container text-center my-5" id="how-it-works-section">
  <h2 class="fw-bold">How it Works</h2>
  <div class="row justify-content-center mt-4" id="how-steps">
    <!-- Dynamic steps will be inserted here -->
  </div>
</section>


<!-- Modals -->
 <!-- Modal -->
<div class="modal fade" id="priceModal" tabindex="-1" aria-labelledby="priceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-4">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-bold" id="priceModalLabel">Estimated Price</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <h3 class="fw-bold text-success" id="estimated-price"></h3>
        <p class="text-muted">Based on your input, this is the estimated price for your bike.</p>
      </div>
      <div class="modal-footer justify-content-center border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Back</button>
        <a id="sell-now-btn" href="./sell_form.html" class="btn btn-primary">Sell Now</a>
 <!-- Replace with your actual sell page URL -->
      </div>
    </div>
  </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", function() {
    // Load background image
    fetch('/api/sell-image/')
        .then(res => res.json())
        .then(data => {
            document.getElementById('sell-section').style.backgroundImage = `url(${data.image_url})`;
        });

    // Load brands
    fetch('/api/brands/')
        .then(res => res.json())
        .then(data => {
            let brandSelect = document.getElementById('brand');
            brandSelect.disabled = false;
            data.brands.forEach(brand => {
                brandSelect.innerHTML += `<option value="${brand.id}">${brand.name}</option>`;
            });
        });

    // On brand change
    document.getElementById('brand').addEventListener('change', function() {
        let brandId = this.value;
        let modelSelect = document.getElementById('model');
        modelSelect.innerHTML = '<option selected>Select Model</option>';
        modelSelect.disabled = true;

        fetch(`/api/models/${brandId}/`)
            .then(res => res.json())
            .then(data => {
                modelSelect.disabled = false;
                data.models.forEach(model => {
                    modelSelect.innerHTML += `<option value="${model.id}">${model.name}</option>`;
                });
            });
    });

    // On model change
    document.getElementById('model').addEventListener('change', function() {
        let modelId = this.value;
        let variantSelect = document.getElementById('variant');
        variantSelect.innerHTML = '<option selected>Select Variant</option>';
        variantSelect.disabled = true;

        fetch(`/api/variants/${modelId}/`)
            .then(res => res.json())
            .then(data => {
                variantSelect.disabled = false;
                data.variants.forEach(variant => {
                    variantSelect.innerHTML += `<option value="${variant.id}" data-launch-year="${variant.launch_year}">${variant.name}</option>`;
                });
            });
    });

    // On variant change, enable year, kms, owner
    document.getElementById('variant').addEventListener('change', function() {
        const selected = this.options[this.selectedIndex];
        const launchYear = parseInt(selected.dataset.launchYear);
        const currentYear = new Date().getFullYear();

        let yearSelect = document.getElementById('year');
        yearSelect.innerHTML = '<option selected>Select Year</option>';
        for (let y = launchYear; y <= currentYear; y++) {
            yearSelect.innerHTML += `<option>${y}</option>`;
        }

        yearSelect.disabled = false;
        document.getElementById('kms').disabled = false;
        document.getElementById('owner').disabled = false;
        document.getElementById('get-price-btn').disabled = false;
    });


    document.getElementById("sell-bike-form").addEventListener("submit", function (e) {
    e.preventDefault();

    const data = {
        brand_id: document.getElementById("brand").value,
        model_id: document.getElementById("model").value,
        variant_id: document.getElementById("variant").value,
        year: document.getElementById("year").value,
        kms: document.getElementById("kms").value,
        owner: document.getElementById("owner").value,
    };

    fetch('/api/v1/get-price/', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: JSON.stringify({
        brand_id: document.getElementById("brand").value,
        model_id: document.getElementById("model").value,
        variant_id: document.getElementById("variant").value,
        year: document.getElementById("year").value,
        kms: document.getElementById("kms").value,
        owner: document.getElementById("owner").value,
    })
})
.then(response => response.json())
.then(result => {
    // Set estimated price in modal
    document.getElementById("estimated-price").textContent = `₹ ${result.price}`;

    // Update "Sell Now" button link dynamically
    //document.getElementById("sell-now-btn").href = `/sell/submit/${result.price}/`;
document.getElementById("sell-now-btn").href = "{% url 'sell:sell_bike_page' %}";


    // Show Bootstrap modal
    const priceModal = new bootstrap.Modal(document.getElementById('priceModal'));
    priceModal.show();
})


.catch(error => {
    console.error("Error:", error);
});
});

});

 fetch("/api/how-it-works/")
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById("how-steps");
      data.steps.forEach((step, index) => {
        container.innerHTML += `
          <div class="col-md-3 text-center">
            <img src="${step.image}" alt="${step.title}" class="img-fluid mb-2" style="min-height: 300px; max-width: 300px">
            <h5 class="fw-bold">${step.title}</h5>
          </div>
          ${index < data.steps.length - 1 ? '<div class="col-md-1 d-flex align-items-center justify-content-center"><span class="fw-bold fs-1">&lt;</span></div>' : ''}
        `;
      });
    });



    // Example JS after price calculation
fetch('/sell/api/get-price/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
    body: JSON.stringify({
        brand_id: selectedBrand,
        model_id: selectedModel,
        variant_id: selectedVariant,
        year: selectedYear,
        kms: selectedKms,
        owner: selectedOwner
    })
})
.then(res => res.json())
.then(data => {
    if(data.price){
        // Redirect to the form with the price
       window.location.href = "{% url 'sell:sell_bike_page' %}";

    }
});


</script>

{% endblock %}
